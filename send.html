<!DOCTYPE html>
<html>
<head>
    <title>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        input, button { padding: 10px; font-size: 16px; margin: 5px; }
        button { background: #28a745; color: white; border: none; cursor: pointer; }
        #status { margin-top: 10px; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h2>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É</h2>
    
    <input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è">
    <input type="text" id="message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" style="width: 300px;">
    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π</button>
    
    <div id="status">–ì–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ</div>
    
    <h3>–°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏:</h3>
    <div id="check-status"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, serverTimestamp,
            doc, getDoc, query, where, getDocs
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCox_zyQP5GMa5W9Tw2cUoBtvkQC-PcrsE",
            authDomain: "school-test-mrzo25.firebaseapp.com",
            projectId: "school-test-mrzo25",
            storageBucket: "school-test-mrzo25.firebasestorage.app",
            messagingSenderId: "143703431012",
            appId: "1:143703431012:web:b02bec2f8b28ce6e2acc71"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function sendMessage() {
            const name = document.getElementById('name').value.trim();
            const message = document.getElementById('message').value.trim();
            const status = document.getElementById('status');
            const checkStatus = document.getElementById('check-status');
            
            if (!message) {
                showStatus(status, "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!", "error");
                return;
            }

            try {
                // –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                showStatus(status, "üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è...", "loading");
                checkStatus.innerHTML = "";
                
                const docRef = await addDoc(collection(db, "messages"), {
                    text: message,
                    user: name || "–ê–Ω–æ–Ω–∏–º",
                    timestamp: serverTimestamp()
                });
                
                const messageId = docRef.id;
                showStatus(status, `‚úì –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (ID: ${messageId})`, "success");
                
                // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É (3 –ø–æ–ø—ã—Ç–∫–∏)
                await checkMessageInDatabase(messageId, message, checkStatus);
                
                // –®–∞–≥ 3: –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                await showAllMessages(checkStatus);
                
                document.getElementById('message').value = '';
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞:", error);
                showStatus(status, `‚úó –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`, "error");
            }
        }

        async function checkMessageInDatabase(messageId, expectedText, checkStatus) {
            checkStatus.innerHTML = "<h4>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É:</h4>";
            
            for (let attempt = 1; attempt <= 3; attempt++) {
                addCheckStep(checkStatus, `–ü–æ–ø—ã—Ç–∫–∞ ${attempt}: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤ –±–∞–∑–µ...`);
                
                try {
                    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ ID
                    const docSnap = await getDoc(doc(db, "messages", messageId));
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.text === expectedText) {
                            addCheckStep(checkStatus, 
                                `‚úì –£–°–ü–ï–•: –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ!<br>
                                 ID: ${messageId}<br>
                                 –¢–µ–∫—Å—Ç: "${data.text}"<br>
                                 –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user}<br>
                                 –í—Ä–µ–º—è: ${data.timestamp ? data.timestamp.toDate().toLocaleTimeString() : '–æ–∂–∏–¥–∞–µ—Ç—Å—è'}`,
                                "success");
                            return true;
                        }
                    }
                    
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∂–¥–µ–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
                    if (attempt < 3) {
                        addCheckStep(checkStatus, "‚è≥ –°–æ–æ–±—â–µ–Ω–∏–µ –µ—â–µ –Ω–µ –ø–æ—è–≤–∏–ª–æ—Å—å, –∂–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É...");
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                } catch (error) {
                    addCheckStep(checkStatus, `–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`, "error");
                }
            }
            
            addCheckStep(checkStatus, "‚ö† –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫", "error");
            return false;
        }

        async function showAllMessages(checkStatus) {
            try {
                addCheckStep(checkStatus, "<br><h4>–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–∞–∑–µ:</h4>");
                
                const querySnapshot = await getDocs(collection(db, "messages"));
                const messagesList = document.createElement('div');
                
                if (querySnapshot.empty) {
                    messagesList.innerHTML = "–í –±–∞–∑–µ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π";
                } else {
                    let html = "<ul>";
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        html += `<li>
                            <strong>${data.user}:</strong> ${data.text}
                            <small>(${doc.id.substring(0, 8)}...)</small>
                        </li>`;
                    });
                    html += "</ul>";
                    messagesList.innerHTML = html;
                }
                
                checkStatus.appendChild(messagesList);
                
            } catch (error) {
                addCheckStep(checkStatus, `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞: ${error.message}`, "error");
            }
        }

        function showStatus(element, text, type) {
            element.innerHTML = text;
            element.className = type;
        }

        function addCheckStep(element, text, type = "") {
            const step = document.createElement('div');
            step.innerHTML = text;
            if (type) step.className = type;
            element.appendChild(step);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        document.getElementById('message').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>